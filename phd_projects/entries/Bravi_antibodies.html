<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.40">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Dr.&nbsp;Barbara Bravi and Prof Mauricio Barahona">
<meta name="dcterms.date" content="2024-03-11">

<title>Machine learning-based biophysical models of antibody properties and function – CCMI</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../static/assets/ccmi_rounded_colour.png" rel="icon" type="image/png">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-549806ee2085284f45b00abea8c6df48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-e01dce85e4dd9d04787a43765b4758b9.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../../styles.css">
<meta property="og:title" content="Machine learning-based biophysical models of antibody properties and function – CCMI">
<meta property="og:description" content="EPSRC Centre for Doctoral Training in Colllaborative Compuational Modelling at the Interface">
<meta property="og:site_name" content="CCMI">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../../static/assets/ccmi_rounded_colour.png" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">CCMI</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../events/event_list.html"> 
<span class="menu-text">Events</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../training/training.html"> 
<span class="menu-text">Training Programme</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../apply.html"> 
<span class="menu-text">How to apply</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../blog/blog_list.html"> 
<span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../faq.html"> 
<span class="menu-text">FAQ</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-about" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">About</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-about">    
        <li>
    <a class="dropdown-item" href="../../team.html">
 <span class="dropdown-text">Our Leadership Team</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../#contact-us">
 <span class="dropdown-text">Contact us</span></a>
  </li>  
    </ul>
  </li>
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Machine learning-based biophysical models of antibody properties and function</h1>
</div>


<div class="quarto-title-meta-author">
  <div class="quarto-title-meta-heading">Supervisor</div>
  <div class="quarto-title-meta-heading">Institution</div>
  
    <div class="quarto-title-meta-contents">
    <p class="author">Dr.&nbsp;Barbara Bravi and Prof Mauricio Barahona </p>
  </div>
  <div class="quarto-title-meta-contents">
        <p class="affiliation">
            Imperial
          </p>
      </div>
  </div>

<div class="quarto-title-meta">

      
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">March 11, 2024</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="project-description" class="level2">
<h2 class="anchored" data-anchor-id="project-description">Project Description</h2>
<p>Antibodies are proteins that play a key role in the immune response against pathogens by binding specifically to the pathogen. The body is able to modify sections of antibodies through mutations to improve the specificity and affinity of the binding to unseen pathogens. Consequently, the design of antibodies as possible therapeutic tools that can bind to specific targets (e.g., pathogens, cancerous cells) is an area of highly active research. However, which molecular and structural properties determine the specific binding of antibodies to protein targets remains unclear, thus hampering our understanding of the mutational effects in the immune response and impeding progress in the rational design of antibodies. In this project, we will develop machine learning methods to predict antibodies’ functional properties related to their binding that are informed by biophysical modelling of their sequence and structure as captured by graph-based representations of antibody-protein interactions. In particular, the aim of these models is to predict and characterize single-site mutations that can improve antibody binding to specific targets without compromising other biophysical properties, with potential applications in antibody design.</p>
<section id="main-objectives-of-the-project" class="level3">
<h3 class="anchored" data-anchor-id="main-objectives-of-the-project">Main objectives of the project</h3>
<p>To achieve our main goal, we will leverage various machine learning approaches which we have developed, and we will develop new ones to exploit the increasing amount of data on antibodies and their cognate target proteins. Schematically, the objectives and tasks of the project will be:</p>
<ol type="1">
<li><p>To train a model that can capture long-range complex dependencies between amino acids at different sites along the antibody/protein amino acid chain, and which, accounting for such dependencies, can provide a single-site measure of amino acid importance to target binding. For this task we will build upon a transformer-like architecture [1].</p></li>
<li><p>To build biophysically informed models of antibody-protein interactions that can give graph representations of such interactions and antibody/protein structures, summarizing and distilling relevant biochemical and structural information. We will employ different graph construction techniques, from geometric graphs that capture packing to biophysical models of energetic interactions to higher-order models (akin to simplicial complexes) that capture many-body interactions in the structure. We will then explore strategies to machine-learn refinements of such graph representations (e.g., GCNs or GNNs) by optimizing the task of predicting antibodytarget binding.</p></li>
<li><p>To set up a multi-task learning framework whereby different prediction tasks are performed jointly (e.g., predicting structural flexibility, binding specificity, binding affinity etc.). Such a framework will rely on graph neural networks and will be designed to obtain single-site predictions of importance to target binding that account for long-range correlations between sites as well as multiple structural and biochemical constraints. These predictions will be key to estimate in silico the effect of mutations and set up a computational framework to guide mutation-based antibody design in the laboratory. Ongoing collaborations with the Imperial Department of Chemistry, as well as with the LiverpoolImperial AIChemy UKRI Hub in AI will allow us to establish links to experimental antibody design for validation and further development.</p></li>
</ol>
</section>
<section id="existing-background-work" class="level3">
<h3 class="anchored" data-anchor-id="existing-background-work">Existing background work</h3>
<p>The field of machine learning approaches to biophysical modelling and design of immune-related proteins like antibodies has witnessed growing activity recently [2]. The supervisors’ group has recently published a machine learning method to predict antibody binding affinity to specific targets that leverages jointly a modelling framework capturing antibodies’ structural fluctuations upon binding and convolutional neural networks [3]. The ongoing research is focussing on biochemically informed graph-based representations of antibody structures [4,5] and on combining them to neural network architectures to model how structural flexibility contributes to antibodies’ functional properties related to target binding.</p>
</section>
<section id="details-of-softwaredata-deliverables" class="level3">
<h3 class="anchored" data-anchor-id="details-of-softwaredata-deliverables">Details of Software/Data Deliverables</h3>
<p>The coding and data developments during the project will consist of well curated computational pipelines comprising:</p>
<ol type="1">
<li><p>Algorithms to produce graph-based representations of protein data combining structural and biochemical information;</p></li>
<li><p>Machine learning architectures (transformers, graph neural networks) taking protein data as input and performing different learning tasks (potentially in a multi-task learning setting).</p></li>
</ol>
<p>The software deliverable will consist of the python packages made freely available e.g.&nbsp;via github (like we did for Ref. [3]) and usable through a webserver (like we did for Ref. [5]). Such software will allow a potential user to: pre-process custom antibody/protein data of interest to produce inputs to the machine learning methods and graph-based representations that can be used for further analysis; evaluate on them the predictions of the machine learning methods; re-train/fine-tune the machine learning architectures on the custom data; extract insights and analyze the predictions for e.g.&nbsp;antibody design purposes.</p>
</section>
<section id="references" class="level3">
<h3 class="anchored" data-anchor-id="references">References:</h3>
<p>[1] Leem, Mitchell, Farmery, Barton, Galson. Deciphering the language of antibodies using selfsupervised learning, 2022. Patterns, 3(7). [2] Bravi. Development and use of machine learning algorithms in vaccine target selection, 2024. npj Vaccines, 9(15). [3] Michalewicz, Barahona, Bravi. ANTIPASTI: interpretable prediction of antibody binding affinity exploiting Normal Modes and Deep Learning, 2024. Structure, 32: 1-13. [4] Song, Barahona, Yaliraki. Bagpype: A python package for the construction of atomistic, energy-weighted graphs from biomolecular structures, 2021. [5] Amor, B., Schaub, M., Yaliraki, S. et al.&nbsp;Prediction of allosteric sites and mediating interactions through bond-to-bond propensities, 2016. Nat Commun, 7:12477.</p>


</section>
</section>

</main> <!-- /main -->
<div class="column-page page-full mt-5 wave-background d-flex flex-column align-items-center justify-content-end">
	<div id="contact-us" class="pt-3 d-flex flex-column align-items-center text-center">
		<h3>Feel free to drop us a line with questions or feedback!</h3>
		<a href="mailto:arc.ccmi-cdt@ucl.ac.uk?subject=CCMI%20Question&amp;body=Hello,%20I%20saw%20your%20website%20and..." class="btn btn--contact mt-2">
			Contact Us</a>
	</div>
	<div class="footer__info w-100 text-center">
		<h5>
			CCMI is a collaboration between UCL and Imperial College, funded by
			<a href="https://www.ukri.org/councils/epsrc/">EPSRC</a>.
		</h5>
		<div id="logos" class="mt-4">
			<a href="https://www.ukri.org/who-we-are/epsrc/">
				<img src="../../static/assets/ukri_logo.png" href="https://www.ukri.org/who-we-are/epsrc/" alt="UKRI logo"></a>
			<img src="../../static/assets/ccmi_square_colour_text.png" alt="CCMI logo">

			<a href="https://www.imperial.ac.uk/">
				<svg xmlns="http://www.w3.org/2000/svg" height="19.48" viewbox="0 0 177.3 19.48">
					<polygon points="73.53 0 73.53 19.47 86.19 19.47 86.19 16.07 77.23 16.07 77.23 11.2 85.41 11.2 85.41 7.89 77.23 7.89 77.23 3.41 86.19 3.41 86.19 0 73.53 0" fill="#fff"></polygon>
					<path d="M58.15,3.14H55.42V9.71h2.73c2.13,0,3.7-1,3.7-3.28s-1.57-3.29-3.7-3.29m.19,9.71H55.42v6.62h-3.7V0h6.62c4.16,0,7.4,1.88,7.4,6.43s-3.27,6.42-7.4,6.42" fill="#fff"></path>
					<polygon points="118.32 0 118.32 3.41 122.89 3.41 122.89 16.07 118.32 16.07 118.32 19.47 131.17 19.47 131.17 16.07 126.59 16.07 126.59 3.41 131.17 3.41 131.17 0 118.32 0" fill="#fff"></polygon>
					<path d="M105.9,6c0,2.34-1.36,3.08-3.7,3.08H99.09v-6h3.11c2.54,0,3.7.94,3.7,2.89m3.9,0c0-4.55-3.12-6-7.21-6h-7.2V19.47h3.7v-7.2h3.62l3.77,7.22h4.1l-4.18-8A5.53,5.53,0,0,0,109.8,6" fill="#fff"></path>
					<path d="M147.4,3.45l2.66,8.6h-5.32ZM145,0l-6.43,19.47h3.9l1.33-4.28H151l1.33,4.28h3.89L149.84,0Z" fill="#fff"></path>
					<polygon points="164.62 0 164.62 19.47 177.3 19.47 177.3 16.07 168.31 16.07 168.31 0 164.62 0" fill="#fff"></polygon>
					<polygon points="37.05 0 32.38 11.45 27.7 0 22.45 0 22.45 19.47 25.95 19.47 25.95 4.91 30.43 15.19 30.63 15.19 34.13 15.19 34.33 15.19 38.8 4.91 38.8 19.47 42.31 19.47 42.31 0 37.05 0" fill="#fff"></polygon>
					<polygon points="0 0 0 3.41 4.58 3.41 4.58 16.07 0 16.07 0 19.47 12.85 19.47 12.85 16.07 8.28 16.07 8.28 3.41 12.85 3.41 12.85 0 0 0" fill="#fff"></polygon>
				</svg>
			</a>
			<a href="https://www.ucl.ac.uk/mathematical-physical-sciences/news/2024/mar/ucl-receives-ps54m-boost-doctoral-training-engineering-and-physical-sciences">
				<img src="../../static/assets/UCL_logo.png" alt="UCL Logo white"></a>
		</div>
	</div>
</div>
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/ccmi-cdt\.org");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>